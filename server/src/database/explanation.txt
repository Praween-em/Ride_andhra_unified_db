-- This script was generated by the ERD tool in pgAdmin 4.
-- Please log an issue at https://github.com/pgadmin-org/pgadmin4/issues/new/choose if you find any bugs, including reproduction steps.
BEGIN;


CREATE TABLE IF NOT EXISTS public.driver_documents
(
    id uuid NOT NULL DEFAULT uuid_generate_v4(),
    driver_id uuid NOT NULL,
    document_type character varying(50) COLLATE pg_catalog."default" NOT NULL,
    document_image text COLLATE pg_catalog."default",
    storage_provider character varying(50) COLLATE pg_catalog."default",
    storage_path text COLLATE pg_catalog."default",
    checksum text COLLATE pg_catalog."default",
    is_encrypted boolean DEFAULT false,
    access_policy jsonb,
    document_number character varying(100) COLLATE pg_catalog."default",
    expiry_date date,
    status document_status_enum DEFAULT 'pending'::document_status_enum,
    verified_by uuid,
    verified_at timestamp with time zone,
    notes text COLLATE pg_catalog."default",
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now(),
    CONSTRAINT driver_documents_pkey PRIMARY KEY (id),
    CONSTRAINT driver_documents_driver_id_document_type_key UNIQUE (driver_id, document_type)
);

CREATE TABLE IF NOT EXISTS public.driver_profiles
(
    user_id uuid NOT NULL,
    first_name character varying(50) COLLATE pg_catalog."default",
    last_name character varying(50) COLLATE pg_catalog."default",
    driver_rating numeric(3, 2) DEFAULT 5.00,
    total_rides integer DEFAULT 0,
    earnings_total numeric(12, 2) DEFAULT 0.00,
    is_available boolean DEFAULT false,
    is_online boolean DEFAULT false,
    current_latitude numeric(10, 6),
    current_longitude numeric(10, 6),
    current_location geography(Point,4326),
    current_address text COLLATE pg_catalog."default",
    status driver_status_enum DEFAULT 'pending_approval'::driver_status_enum,
    vehicle_type vehicle_type_enum,
    vehicle_model character varying(100) COLLATE pg_catalog."default",
    vehicle_color character varying(30) COLLATE pg_catalog."default",
    vehicle_plate_number character varying(50) COLLATE pg_catalog."default",
    approved_at timestamp with time zone,
    approved_by uuid,
    document_submission_status character varying(30) COLLATE pg_catalog."default" DEFAULT 'pending'::character varying,
    background_check_passed boolean DEFAULT false,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now(),
    CONSTRAINT driver_profiles_pkey PRIMARY KEY (user_id),
    CONSTRAINT driver_profiles_vehicle_plate_number_key UNIQUE (vehicle_plate_number)
);

CREATE TABLE IF NOT EXISTS public.external_auth_sessions
(
    id uuid NOT NULL DEFAULT uuid_generate_v4(),
    phone_number character varying(15) COLLATE pg_catalog."default" NOT NULL,
    provider character varying(50) COLLATE pg_catalog."default" NOT NULL,
    provider_session_id text COLLATE pg_catalog."default",
    provider_token text COLLATE pg_catalog."default",
    provider_token_expires_at timestamp with time zone,
    provider_response jsonb,
    verified boolean DEFAULT false,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now(),
    CONSTRAINT external_auth_sessions_pkey PRIMARY KEY (id)
);

CREATE TABLE IF NOT EXISTS public.fare_settings
(
    id uuid NOT NULL DEFAULT uuid_generate_v4(),
    vehicle_type vehicle_type_enum NOT NULL,
    base_fare numeric(12, 2) NOT NULL,
    per_km_rate numeric(10, 4) NOT NULL,
    per_minute_rate numeric(10, 4) NOT NULL,
    minimum_fare numeric(12, 2) NOT NULL,
    surge_multiplier numeric(6, 3) DEFAULT 1.00,
    is_active boolean DEFAULT true,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now(),
    CONSTRAINT fare_settings_pkey PRIMARY KEY (id),
    CONSTRAINT fare_settings_vehicle_type_key UNIQUE (vehicle_type)
);

CREATE TABLE IF NOT EXISTS public.fare_tiers
(
    id uuid NOT NULL DEFAULT uuid_generate_v4(),
    vehicle_type vehicle_type_enum NOT NULL,
    km_from numeric(10, 3) NOT NULL,
    km_to numeric(10, 3) NOT NULL,
    per_km_rate numeric(10, 4) NOT NULL,
    per_minute_rate numeric(10, 4) DEFAULT NULL::numeric,
    effective_from timestamp with time zone DEFAULT now(),
    is_active boolean DEFAULT true,
    CONSTRAINT fare_tiers_pkey PRIMARY KEY (id)
);

CREATE TABLE IF NOT EXISTS public.notification_preferences
(
    id uuid NOT NULL DEFAULT uuid_generate_v4(),
    user_id uuid NOT NULL,
    channel character varying(20) COLLATE pg_catalog."default" DEFAULT 'push'::character varying,
    enabled boolean DEFAULT true,
    types jsonb DEFAULT '[]'::jsonb,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now(),
    CONSTRAINT notification_preferences_pkey PRIMARY KEY (id),
    CONSTRAINT notification_preferences_user_id_channel_key UNIQUE (user_id, channel)
);

CREATE TABLE IF NOT EXISTS public.notification_queue
(
    id uuid NOT NULL DEFAULT uuid_generate_v4(),
    user_id uuid NOT NULL,
    type notification_type_enum NOT NULL,
    payload jsonb NOT NULL,
    channel character varying(20) COLLATE pg_catalog."default" DEFAULT 'push'::character varying,
    attempt_count integer DEFAULT 0,
    next_attempt_at timestamp with time zone DEFAULT now(),
    status character varying(20) COLLATE pg_catalog."default" DEFAULT 'pending'::character varying,
    created_at timestamp with time zone DEFAULT now(),
    CONSTRAINT notification_queue_pkey PRIMARY KEY (id)
);

CREATE TABLE IF NOT EXISTS public.notifications
(
    id uuid NOT NULL DEFAULT uuid_generate_v4(),
    user_id uuid NOT NULL,
    ride_id uuid,
    type notification_type_enum NOT NULL,
    title character varying(200) COLLATE pg_catalog."default" NOT NULL,
    message text COLLATE pg_catalog."default" NOT NULL,
    data jsonb,
    is_read boolean DEFAULT false,
    created_at timestamp with time zone DEFAULT now(),
    CONSTRAINT notifications_pkey PRIMARY KEY (id)
);

CREATE TABLE IF NOT EXISTS public.otps
(
    id uuid NOT NULL DEFAULT uuid_generate_v4(),
    phone_number character varying(15) COLLATE pg_catalog."default" NOT NULL,
    otp_code character varying(6) COLLATE pg_catalog."default" NOT NULL,
    purpose character varying(50) COLLATE pg_catalog."default" DEFAULT 'login'::character varying,
    is_verified boolean DEFAULT false,
    expires_at timestamp with time zone NOT NULL,
    created_at timestamp with time zone DEFAULT now(),
    CONSTRAINT otps_pkey PRIMARY KEY (id)
);

CREATE TABLE IF NOT EXISTS public.payments
(
    id uuid NOT NULL DEFAULT uuid_generate_v4(),
    ride_id uuid NOT NULL,
    user_id uuid NOT NULL,
    amount numeric(12, 2) NOT NULL,
    currency character varying(10) COLLATE pg_catalog."default" DEFAULT 'INR'::character varying,
    payment_method payment_method_enum,
    transaction_id character varying(200) COLLATE pg_catalog."default",
    status payment_status_enum DEFAULT 'pending'::payment_status_enum,
    gateway_response jsonb,
    paid_at timestamp with time zone,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now(),
    CONSTRAINT payments_pkey PRIMARY KEY (id),
    CONSTRAINT payments_transaction_id_key UNIQUE (transaction_id)
);

CREATE TABLE IF NOT EXISTS public.ride_ratings
(
    id uuid NOT NULL DEFAULT uuid_generate_v4(),
    ride_id uuid NOT NULL,
    rater_user_id uuid NOT NULL,
    rated_user_id uuid NOT NULL,
    rating integer NOT NULL,
    review text COLLATE pg_catalog."default",
    created_at timestamp with time zone DEFAULT now(),
    CONSTRAINT ride_ratings_pkey PRIMARY KEY (id)
);

CREATE TABLE IF NOT EXISTS public.rider_pin_attempts
(
    id uuid NOT NULL DEFAULT uuid_generate_v4(),
    rider_id uuid NOT NULL,
    driver_id uuid,
    ride_id uuid,
    attempt_ts timestamp with time zone DEFAULT now(),
    success boolean,
    ip_address character varying(64) COLLATE pg_catalog."default",
    notes text COLLATE pg_catalog."default",
    CONSTRAINT rider_pin_attempts_pkey PRIMARY KEY (id)
);

CREATE TABLE IF NOT EXISTS public.rider_profiles
(
    user_id uuid NOT NULL,
    rider_rating numeric(3, 2) DEFAULT 5.00,
    total_rides integer DEFAULT 0,
    favorite_locations jsonb,
    pin_required boolean DEFAULT true,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now(),
    CONSTRAINT rider_profiles_pkey PRIMARY KEY (user_id)
);

CREATE TABLE IF NOT EXISTS public.rides
(
    id uuid NOT NULL DEFAULT uuid_generate_v4(),
    rider_id uuid NOT NULL,
    driver_id uuid,
    pickup_latitude numeric(10, 6) NOT NULL,
    pickup_longitude numeric(10, 6) NOT NULL,
    pickup_location geography(Point,4326) NOT NULL,
    pickup_address text COLLATE pg_catalog."default" NOT NULL,
    dropoff_latitude numeric(10, 6) NOT NULL,
    dropoff_longitude numeric(10, 6) NOT NULL,
    dropoff_location geography(Point,4326) NOT NULL,
    dropoff_address text COLLATE pg_catalog."default" NOT NULL,
    vehicle_type vehicle_type_enum NOT NULL,
    estimated_distance_km numeric(10, 3),
    estimated_duration_min integer,
    estimated_fare numeric(12, 2),
    actual_distance_km numeric(10, 3),
    actual_duration_min integer,
    final_fare numeric(12, 2),
    status ride_status_enum DEFAULT 'pending'::ride_status_enum,
    cancellation_reason text COLLATE pg_catalog."default",
    cancelled_by user_role_enum,
    rider_rating integer,
    driver_rating integer,
    rider_review text COLLATE pg_catalog."default",
    driver_review text COLLATE pg_catalog."default",
    requested_at timestamp with time zone DEFAULT now(),
    accepted_at timestamp with time zone,
    started_at timestamp with time zone,
    completed_at timestamp with time zone,
    cancelled_at timestamp with time zone,
    rider_pin_entered_by_driver boolean DEFAULT false,
    rider_pin_verified_at timestamp with time zone,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now(),
    CONSTRAINT rides_pkey PRIMARY KEY (id)
);

CREATE TABLE IF NOT EXISTS public.transactions
(
    id uuid NOT NULL DEFAULT uuid_generate_v4(),
    wallet_id uuid NOT NULL,
    ride_id uuid,
    payment_id uuid,
    amount numeric(14, 2) NOT NULL,
    type transaction_type_enum NOT NULL,
    description text COLLATE pg_catalog."default",
    balance_after numeric(14, 2) NOT NULL,
    created_at timestamp with time zone DEFAULT now(),
    CONSTRAINT transactions_pkey PRIMARY KEY (id)
);

CREATE TABLE IF NOT EXISTS public.users
(
    id uuid NOT NULL DEFAULT uuid_generate_v4(),
    phone_number character varying(15) COLLATE pg_catalog."default" NOT NULL,
    name character varying(150) COLLATE pg_catalog."default",
    email character varying(254) COLLATE pg_catalog."default",
    role user_role_enum NOT NULL DEFAULT 'rider'::user_role_enum,
    profile_image text COLLATE pg_catalog."default",
    is_verified boolean DEFAULT false,
    is_blocked boolean DEFAULT false,
    rating_avg numeric(3, 2) DEFAULT 5.00,
    rating_count integer DEFAULT 0,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now(),
    rider_pin character varying(4) COLLATE pg_catalog."default",
    push_token text COLLATE pg_catalog."default",
    CONSTRAINT users_pkey PRIMARY KEY (id),
    CONSTRAINT users_phone_number_key UNIQUE (phone_number),
    CONSTRAINT users_rider_pin_key UNIQUE (rider_pin)
);

CREATE TABLE IF NOT EXISTS public.wallet_transactions
(
    id uuid NOT NULL DEFAULT uuid_generate_v4(),
    wallet_id uuid NOT NULL,
    amount numeric(10, 2) NOT NULL,
    transaction_type character varying COLLATE pg_catalog."default" NOT NULL,
    reference_type character varying COLLATE pg_catalog."default" NOT NULL,
    reference_id character varying COLLATE pg_catalog."default" NOT NULL,
    description character varying COLLATE pg_catalog."default" NOT NULL,
    balance_after numeric(10, 2) NOT NULL,
    created_at timestamp without time zone NOT NULL DEFAULT now(),
    CONSTRAINT "PK_wallet_transactions_id" PRIMARY KEY (id)
);

CREATE TABLE IF NOT EXISTS public.wallets
(
    id uuid NOT NULL DEFAULT uuid_generate_v4(),
    user_id uuid NOT NULL,
    balance numeric(14, 2) NOT NULL DEFAULT 0.00,
    currency character varying(10) COLLATE pg_catalog."default" DEFAULT 'INR'::character varying,
    is_active boolean DEFAULT true,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now(),
    CONSTRAINT wallets_pkey PRIMARY KEY (id),
    CONSTRAINT wallets_user_id_key UNIQUE (user_id)
);

ALTER TABLE IF EXISTS public.driver_documents
    ADD CONSTRAINT driver_documents_driver_id_fkey FOREIGN KEY (driver_id)
    REFERENCES public.driver_profiles (user_id) MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE CASCADE;


ALTER TABLE IF EXISTS public.driver_documents
    ADD CONSTRAINT driver_documents_verified_by_fkey FOREIGN KEY (verified_by)
    REFERENCES public.users (id) MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE NO ACTION;


ALTER TABLE IF EXISTS public.driver_profiles
    ADD CONSTRAINT driver_profiles_approved_by_fkey FOREIGN KEY (approved_by)
    REFERENCES public.users (id) MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE NO ACTION;


ALTER TABLE IF EXISTS public.driver_profiles
    ADD CONSTRAINT driver_profiles_user_id_fkey FOREIGN KEY (user_id)
    REFERENCES public.users (id) MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE CASCADE;
CREATE INDEX IF NOT EXISTS driver_profiles_pkey
    ON public.driver_profiles(user_id);


ALTER TABLE IF EXISTS public.fare_tiers
    ADD CONSTRAINT fare_tiers_vehicle_fk FOREIGN KEY (vehicle_type)
    REFERENCES public.fare_settings (vehicle_type) MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE NO ACTION;
CREATE INDEX IF NOT EXISTS idx_fare_tiers_vehicle
    ON public.fare_tiers(vehicle_type);


ALTER TABLE IF EXISTS public.notification_preferences
    ADD CONSTRAINT notification_preferences_user_id_fkey FOREIGN KEY (user_id)
    REFERENCES public.users (id) MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE CASCADE;


ALTER TABLE IF EXISTS public.notification_queue
    ADD CONSTRAINT notification_queue_user_id_fkey FOREIGN KEY (user_id)
    REFERENCES public.users (id) MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE CASCADE;


ALTER TABLE IF EXISTS public.notifications
    ADD CONSTRAINT notifications_ride_id_fkey FOREIGN KEY (ride_id)
    REFERENCES public.rides (id) MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE NO ACTION;


ALTER TABLE IF EXISTS public.notifications
    ADD CONSTRAINT notifications_user_id_fkey FOREIGN KEY (user_id)
    REFERENCES public.users (id) MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE CASCADE;
CREATE INDEX IF NOT EXISTS idx_notifications_user_id
    ON public.notifications(user_id);


ALTER TABLE IF EXISTS public.payments
    ADD CONSTRAINT payments_ride_id_fkey FOREIGN KEY (ride_id)
    REFERENCES public.rides (id) MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE CASCADE;
CREATE INDEX IF NOT EXISTS idx_payments_ride_id
    ON public.payments(ride_id);


ALTER TABLE IF EXISTS public.payments
    ADD CONSTRAINT payments_user_id_fkey FOREIGN KEY (user_id)
    REFERENCES public.users (id) MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE CASCADE;


ALTER TABLE IF EXISTS public.ride_ratings
    ADD CONSTRAINT ride_ratings_rated_user_id_fkey FOREIGN KEY (rated_user_id)
    REFERENCES public.users (id) MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE NO ACTION;
CREATE INDEX IF NOT EXISTS idx_ride_ratings_rated_user
    ON public.ride_ratings(rated_user_id);


ALTER TABLE IF EXISTS public.ride_ratings
    ADD CONSTRAINT ride_ratings_rater_user_id_fkey FOREIGN KEY (rater_user_id)
    REFERENCES public.users (id) MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE NO ACTION;


ALTER TABLE IF EXISTS public.ride_ratings
    ADD CONSTRAINT ride_ratings_ride_id_fkey FOREIGN KEY (ride_id)
    REFERENCES public.rides (id) MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE CASCADE;


ALTER TABLE IF EXISTS public.rider_pin_attempts
    ADD CONSTRAINT rider_pin_attempts_rider_id_fkey FOREIGN KEY (rider_id)
    REFERENCES public.users (id) MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE CASCADE;
CREATE INDEX IF NOT EXISTS idx_rider_pin_attempts
    ON public.rider_pin_attempts(rider_id);


ALTER TABLE IF EXISTS public.rider_profiles
    ADD CONSTRAINT rider_profiles_user_id_fkey FOREIGN KEY (user_id)
    REFERENCES public.users (id) MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE CASCADE;
CREATE INDEX IF NOT EXISTS rider_profiles_pkey
    ON public.rider_profiles(user_id);


ALTER TABLE IF EXISTS public.rides
    ADD CONSTRAINT rides_driver_id_fkey FOREIGN KEY (driver_id)
    REFERENCES public.users (id) MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE RESTRICT;
CREATE INDEX IF NOT EXISTS idx_rides_driver_id
    ON public.rides(driver_id);


ALTER TABLE IF EXISTS public.rides
    ADD CONSTRAINT rides_rider_id_fkey FOREIGN KEY (rider_id)
    REFERENCES public.users (id) MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE RESTRICT;
CREATE INDEX IF NOT EXISTS idx_rides_rider_id
    ON public.rides(rider_id);


ALTER TABLE IF EXISTS public.transactions
    ADD CONSTRAINT transactions_payment_id_fkey FOREIGN KEY (payment_id)
    REFERENCES public.payments (id) MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE NO ACTION;


ALTER TABLE IF EXISTS public.transactions
    ADD CONSTRAINT transactions_ride_id_fkey FOREIGN KEY (ride_id)
    REFERENCES public.rides (id) MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE NO ACTION;


ALTER TABLE IF EXISTS public.transactions
    ADD CONSTRAINT transactions_wallet_id_fkey FOREIGN KEY (wallet_id)
    REFERENCES public.wallets (id) MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE CASCADE;
CREATE INDEX IF NOT EXISTS idx_transactions_wallet_id
    ON public.transactions(wallet_id);


ALTER TABLE IF EXISTS public.wallet_transactions
    ADD CONSTRAINT "FK_wallet_transactions_wallet_id" FOREIGN KEY (wallet_id)
    REFERENCES public.wallets (id) MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE NO ACTION;


ALTER TABLE IF EXISTS public.wallets
    ADD CONSTRAINT wallets_user_id_fkey FOREIGN KEY (user_id)
    REFERENCES public.users (id) MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE CASCADE;
CREATE INDEX IF NOT EXISTS wallets_user_id_key
    ON public.wallets(user_id);

END;